<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsightVault | ç¨åé˜…è¯»</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Playfair+Display:wght@600&display=swap');
        :root {
            --bg-1: #f8f2e7;
            --bg-2: #e8f4f1;
            --ink: #1b1f23;
            --muted: #667085;
            --primary: #0e7c7b;
            --accent: #f76c4f;
            --card: rgba(255, 255, 255, 0.95);
            --line: rgba(20, 20, 20, 0.08);
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Space Grotesk', sans-serif;
            color: var(--ink);
            background:
                radial-gradient(circle at 10% 20%, rgba(247, 108, 79, 0.15), transparent 40%),
                radial-gradient(circle at 80% 10%, rgba(14, 124, 123, 0.18), transparent 35%),
                linear-gradient(160deg, var(--bg-1), var(--bg-2));
            min-height: 100vh;
            overflow: hidden;
        }
        .container {
            display: flex;
            height: 100vh;
            padding: 0;
        }
        .sidebar {
            width: 380px;
            background: var(--card);
            border-right: 1px solid var(--line);
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 20px;
            border-bottom: 1px solid var(--line);
        }
        .brand {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            margin-bottom: 4px;
        }
        .brand-subtitle {
            font-size: 12px;
            color: var(--muted);
        }
        .nav-links {
            margin-top: 12px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .nav-links a {
            color: var(--ink);
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
        }
        .filters {
            padding: 16px 20px;
            border-bottom: 1px solid var(--line);
            display: flex;
            gap: 8px;
        }
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--line);
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .filter-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        .list-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .list-item {
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .list-item:hover {
            box-shadow: 0 4px 12px rgba(14, 124, 123, 0.1);
            transform: translateY(-1px);
        }
        .list-item.active {
            border-color: var(--primary);
            background: #f0faf9;
        }
        .list-item-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .list-item-meta {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: #f0f0f0;
        }
        .badge-read {
            background: #e0f2f1;
            color: var(--primary);
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .content-header {
            padding: 20px 32px;
            border-bottom: 1px solid var(--line);
            background: var(--card);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-pill {
            padding: 6px 10px;
            border-radius: 999px;
            background: #fff;
            border: 1px solid var(--line);
            font-size: 12px;
            color: var(--muted);
        }
        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--muted);
        }
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        .article-title {
            font-size: 32px;
            font-weight: 700;
            margin: 0 0 16px 0;
            line-height: 1.3;
        }
        .article-meta {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--line);
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        .article-meta a {
            color: var(--primary);
            text-decoration: none;
        }
        .article-content {
            max-width: 800px;
            line-height: 1.8;
            font-size: 16px;
        }
        .article-content h1 { font-size: 28px; margin: 32px 0 16px; }
        .article-content h2 { font-size: 24px; margin: 28px 0 14px; }
        .article-content h3 { font-size: 20px; margin: 24px 0 12px; }
        .article-content p { margin: 16px 0; }
        .article-content pre {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
        .article-content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .article-content pre code {
            background: none;
            padding: 0;
        }
        .article-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 24px 0;
        }
        .article-content blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 16px;
            margin: 20px 0;
            color: var(--muted);
            font-style: italic;
        }
        .btn-group {
            display: flex;
            gap: 8px;
        }
        button {
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid transparent;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        .btn-primary:hover {
            background: #0a615f;
        }
        .btn-ghost {
            background: transparent;
            border-color: var(--ink);
            color: var(--ink);
        }
        .btn-ghost:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        .btn-accent {
            background: var(--accent);
            color: #fff;
        }
        .btn-accent:hover {
            background: #e55a3e;
        }
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--ink);
            color: #fff;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            animation: toastIn 0.3s ease-out;
        }
        @keyframes toastIn {
            from { bottom: 0; opacity: 0; }
            to { bottom: 24px; opacity: 1; }
        }
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: 50vh;
            }
            .main-content {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <div class="brand">ğŸ“š ç¨åé˜…è¯»</div>
                <div class="brand-subtitle">æ”¶é›†ä¸æ•´ç†ä½ çš„ç½‘ç»œå‘ç°</div>
                <div class="nav-links">
                    <a href="/app">æƒ…æŠ¥åº“</a>
                    <a href="/groups">å›¢é˜Ÿ</a>
                    <a href="#" onclick="logout()">é€€å‡º</a>
                </div>
            </div>
            <div class="filters">
                <button class="filter-btn active" data-filter="all" onclick="switchFilter('all')">å…¨éƒ¨</button>
                <button class="filter-btn" data-filter="unread" onclick="switchFilter('unread')">æœªè¯»</button>
                <button class="filter-btn" data-filter="read" onclick="switchFilter('read')">å·²è¯»</button>
                <button class="filter-btn" data-filter="archived" onclick="switchFilter('archived')">å·²å½’æ¡£</button>
            </div>
            <div class="list-container" id="listContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <div>æš‚æ— å†…å®¹</div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="content-header">
                <div class="user-info">
                    <span class="user-pill" id="userPill">æœªç™»å½•</span>
                </div>
                <div class="btn-group" id="articleActions" style="display: none;">
                    <button class="btn-primary" onclick="toggleRead()">æ ‡è®°ä¸º<span id="readToggleText">å·²è¯»</span></button>
                    <button class="btn-ghost" onclick="saveToVault()">ä¿å­˜åˆ°æƒ…æŠ¥åº“</button>
                    <button class="btn-accent" onclick="deleteReading()">åˆ é™¤</button>
                </div>
            </div>
            <div class="content-body" id="contentBody">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘ˆ</div>
                    <div>ä»å·¦ä¾§é€‰æ‹©ä¸€ç¯‡æ–‡ç« å¼€å§‹é˜…è¯»</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken') || '';
        let currentUser = null;
        let currentFilter = 'all';
        let currentItem = null;

        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: true,
            mangle: false
        });

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('authUser');
            window.location.href = '/login';
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = { method };
                if (body) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(body);
                }
                if (authToken) {
                    options.headers = options.headers || {};
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                }
                const res = await fetch(endpoint, options);
                if (res.status === 401) {
                    logout();
                    return null;
                }
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(errorText || `HTTP ${res.status}`);
                }
                return await res.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function loadMe() {
            const res = await apiCall('/api/auth/me');
            if (!res || !res.user) {
                window.location.href = '/login';
                return;
            }
            currentUser = res.user;
            document.getElementById('userPill').innerText = currentUser.name || currentUser.email;
        }

        async function loadList() {
            const res = await apiCall(`/api/v1/reading-list?filter=${currentFilter}`);
            const container = document.getElementById('listContainer');
            
            if (!res || !res.data || res.data.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div>${currentFilter === 'all' ? 'æš‚æ— å†…å®¹' : 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å†…å®¹'}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            res.data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.id = `item-${item.id}`;
                if (currentItem && currentItem.id === item.id) {
                    div.classList.add('active');
                }
                
                const createdAt = new Date(item.created_at).toLocaleDateString('zh-CN');
                const badges = [];
                if (item.is_read) badges.push('<span class="badge badge-read">å·²è¯»</span>');
                if (!item.has_content) badges.push('<span class="badge">ä»…é“¾æ¥</span>');
                
                div.innerHTML = `
                    <div class="list-item-title"></div>
                    <div class="list-item-meta">
                        <span>${item.source || new URL(item.url).hostname}</span>
                        <span>${createdAt}</span>
                        ${badges.join('')}
                    </div>
                `;
                
                div.querySelector('.list-item-title').textContent = item.title;
                div.onclick = () => viewArticle(item.id);
                container.appendChild(div);
            });
        }

        async function viewArticle(itemId) {
            const res = await apiCall(`/api/v1/reading-list/${itemId}`);
            if (!res || !res.data) {
                showToast('åŠ è½½å¤±è´¥');
                return;
            }
            
            currentItem = res.data;
            
            // æ›´æ–°å·¦ä¾§åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.list-item').forEach(el => el.classList.remove('active'));
            const itemEl = document.getElementById(`item-${itemId}`);
            if (itemEl) itemEl.classList.add('active');
            
            const contentBody = document.getElementById('contentBody');
            const articleActions = document.getElementById('articleActions');
            
            if (!currentItem.has_content) {
                // æ²¡æœ‰å†…å®¹ï¼Œæ˜¾ç¤ºæç¤ºå¹¶æä¾›æ‰“å¼€é“¾æ¥æŒ‰é’®
                contentBody.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”—</div>
                        <h2 style="margin: 16px 0; color: var(--ink);">æœªèƒ½è·å–æ–‡ç« å†…å®¹</h2>
                        <p style="margin-bottom: 24px;">æ­¤æ–‡ç« ä»…ä¿å­˜äº†é“¾æ¥ï¼Œæ‚¨å¯ä»¥ï¼š</p>
                        <button class="btn-primary" onclick="window.open('${currentItem.url}', '_blank')" style="font-size: 15px; padding: 12px 24px;">
                            åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€åŸæ–‡
                        </button>
                    </div>
                `;
                articleActions.innerHTML = `
                    <button class="btn-accent" onclick="deleteReading()">åˆ é™¤</button>
                `;
            } else {
                // æœ‰å†…å®¹ï¼Œæ¸²æŸ“æ–‡ç« 
                const rawHtml = marked.parse(currentItem.content);
                const cleanHtml = DOMPurify.sanitize(rawHtml, {
                    ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'u', 's', 'a', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'img', 'hr'],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class']
                });
                
                contentBody.innerHTML = `
                    <article>
                        <h1 class="article-title"></h1>
                        <div class="article-meta">
                            <span>æ¥æº: <a href="${currentItem.url}" target="_blank">${currentItem.source || new URL(currentItem.url).hostname}</a></span>
                            <span>æ”¶è—äº: ${new Date(currentItem.created_at).toLocaleString('zh-CN')}</span>
                        </div>
                        <div class="article-content">${cleanHtml}</div>
                    </article>
                `;
                contentBody.querySelector('.article-title').textContent = currentItem.title;
                
                articleActions.innerHTML = `
                    <button class="btn-primary" onclick="toggleRead()">æ ‡è®°ä¸º<span id="readToggleText">${currentItem.is_read ? 'æœªè¯»' : 'å·²è¯»'}</span></button>
                    <button class="btn-ghost" onclick="saveToVault()">ä¿å­˜åˆ°æƒ…æŠ¥åº“</button>
                    <button class="btn-accent" onclick="deleteReading()">åˆ é™¤</button>
                `;
            }
            
            articleActions.style.display = 'flex';
        }

        async function toggleRead() {
            if (!currentItem) return;
            
            const newReadStatus = !currentItem.is_read;
            await apiCall(`/api/v1/reading-list/${currentItem.id}`, 'PUT', {
                is_read: newReadStatus
            });
            
            currentItem.is_read = newReadStatus;
            document.getElementById('readToggleText').textContent = newReadStatus ? 'æœªè¯»' : 'å·²è¯»';
            showToast(newReadStatus ? 'å·²æ ‡è®°ä¸ºå·²è¯»' : 'å·²æ ‡è®°ä¸ºæœªè¯»');
            
            await loadList();
        }

        async function saveToVault() {
            if (!currentItem) return;
            
            if (!currentItem.has_content) {
                showToast('æ— æ³•ä¿å­˜ï¼šè¯¥æ–‡ç« æ²¡æœ‰å†…å®¹');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦å°†æ­¤æ–‡ç« ä¿å­˜åˆ°æƒ…æŠ¥åº“å—ï¼Ÿ\nä¿å­˜åå°†è‡ªåŠ¨å½’æ¡£ã€‚')) return;
            
            try {
                const res = await apiCall(`/api/v1/reading-list/${currentItem.id}/save-to-vault`, 'POST');
                showToast('å·²ä¿å­˜åˆ°æƒ…æŠ¥åº“');
                await loadList();
                
                // æ¸…ç©ºå³ä¾§æ˜¾ç¤º
                document.getElementById('contentBody').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âœ…</div>
                        <h2 style="margin: 16px 0; color: var(--ink);">å·²ä¿å­˜åˆ°æƒ…æŠ¥åº“</h2>
                        <p>è¯¥æ–‡ç« å·²å½’æ¡£ï¼Œæ‚¨å¯ä»¥åœ¨æƒ…æŠ¥åº“ä¸­æŸ¥çœ‹å’Œæœç´¢ã€‚</p>
                    </div>
                `;
                document.getElementById('articleActions').style.display = 'none';
                currentItem = null;
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥');
            }
        }

        async function deleteReading() {
            if (!currentItem) return;
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
            
            try {
                await apiCall(`/api/v1/reading-list/${currentItem.id}`, 'DELETE');
                showToast('å·²åˆ é™¤');
                await loadList();
                
                document.getElementById('contentBody').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘ˆ</div>
                        <div>ä»å·¦ä¾§é€‰æ‹©ä¸€ç¯‡æ–‡ç« å¼€å§‹é˜…è¯»</div>
                    </div>
                `;
                document.getElementById('articleActions').style.display = 'none';
                currentItem = null;
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥');
            }
        }

        function switchFilter(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            loadList();
        }

        // åˆå§‹åŒ–
        (async function init() {
            await loadMe();
            await loadList();
        })();
    </script>
</body>
</html>
