<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsightVault | 快传</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&family=Fraunces:wght@600&display=swap">
    <style>
        :root {
            --bg: #0f172a;
            --bg-2: #1f2937;
            --card: rgba(255, 255, 255, 0.06);
            --ink: #f8fafc;
            --muted: #cbd5f5;
            --accent: #38bdf8;
            --accent-2: #fb7185;
            --line: rgba(255, 255, 255, 0.1);
            --radius: 16px;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Manrope', sans-serif;
            color: var(--ink);
            background:
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.15), transparent 35%),
                radial-gradient(circle at 80% 10%, rgba(251, 113, 133, 0.18), transparent 30%),
                linear-gradient(160deg, var(--bg), var(--bg-2));
            min-height: 100vh;
        }
        .wrap { max-width: 980px; margin: 0 auto; padding: 40px 18px 80px; }
        .header {
            display: flex; align-items: center; justify-content: space-between; gap: 16px;
            margin-bottom: 24px;
        }
        .title {
            font-family: 'Fraunces', serif;
            font-size: 28px;
            letter-spacing: 0.4px;
        }
        .nav a {
            color: var(--ink); text-decoration: none; font-weight: 600; margin-left: 14px;
        }
        .hero {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 24px;
            padding: 28px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.35);
        }
        .hero h2 { margin: 0 0 8px; font-size: 20px; }
        .hero p { margin: 0; color: var(--muted); }

        .grid {
            display: grid; grid-template-columns: 1.2fr 1fr; gap: 18px;
            margin-top: 18px;
        }
        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 18px;
        }
        .drop {
            border: 1px dashed rgba(56, 189, 248, 0.6);
            border-radius: 18px;
            padding: 24px;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: rgba(15, 23, 42, 0.5);
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        .drop.drag { transform: translateY(-2px); border-color: var(--accent-2); }
        .btn {
            border: none;
            background: var(--accent);
            color: #0b1220;
            font-weight: 700;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
        }
        .btn-ghost {
            background: transparent;
            border: 1px solid var(--line);
            color: var(--ink);
        }
        .muted { color: var(--muted); font-size: 13px; }
        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .input {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--line);
            color: var(--ink);
            border-radius: 10px;
            padding: 10px 12px;
            flex: 1;
            min-width: 180px;
        }
        .queue {
            display: flex; flex-direction: column; gap: 10px; margin-top: 14px;
        }
        .queue-item {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 10px 12px;
        }
        .bar {
            height: 6px; border-radius: 999px; background: rgba(255, 255, 255, 0.1);
            overflow: hidden; margin-top: 8px;
        }
        .bar > span {
            display: block; height: 100%; width: 0%; background: var(--accent-2);
            transition: width 0.2s ease;
        }
        .recent a { color: var(--accent); text-decoration: none; }
        .recent-item { display: flex; justify-content: space-between; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--line); }
        .recent-item:last-child { border-bottom: none; }

        @media (max-width: 900px) {
            .grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="header">
            <div class="title">QuickDrop</div>
            <div class="nav">
                <a href="/cloud">云盘</a>
                <a href="/app">情报库</a>
                <a href="/login">登录</a>
            </div>
        </div>

        <div class="hero">
            <h2>快速传图/文件到电脑</h2>
            <p>手机打开本页上传，电脑在云盘中浏览或直接在本页获取下载链接。</p>
        </div>

        <div class="grid">
            <div class="card">
                <div class="row" style="margin-bottom: 10px;">
                    <button class="btn" id="pickBtn">选择文件</button>
                    <button class="btn btn-ghost" id="pasteBtn">粘贴图片</button>
                    <span class="muted">支持拖拽、粘贴、相册/相机</span>
                </div>

                <div class="drop" id="dropZone">
                    <div>
                        <div style="font-size: 16px; font-weight: 700;">拖拽文件到这里</div>
                        <div class="muted" style="margin-top: 6px;">或直接粘贴截图</div>
                    </div>
                </div>

                <input id="fileInput" type="file" multiple accept="image/*,application/pdf,video/*,audio/*" capture="environment" style="display:none;" />

                <div class="queue" id="uploadQueue"></div>
            </div>

            <div class="card">
                <div style="font-weight: 700; margin-bottom: 8px;">登录令牌</div>
                <div class="muted" style="margin-bottom: 10px;">第一次使用请在登录页获取 Token，或直接把 Token 拼在 URL 参数里打开（?token=xxx）。</div>
                <div class="row">
                    <input class="input" id="tokenInput" placeholder="粘贴 authToken" />
                    <button class="btn" id="saveTokenBtn">保存</button>
                </div>

                <div style="font-weight: 700; margin: 18px 0 8px;">最近上传</div>
                <div class="recent" id="recentList">
                    <div class="muted">本次会话暂无上传。</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tokenKey = 'authToken';
        const urlToken = new URLSearchParams(window.location.search).get('token');
        if (urlToken) {
            localStorage.setItem(tokenKey, urlToken);
            history.replaceState(null, '', window.location.pathname);
        }

        const pickBtn = document.getElementById('pickBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const uploadQueue = document.getElementById('uploadQueue');
        const recentList = document.getElementById('recentList');
        const tokenInput = document.getElementById('tokenInput');
        const saveTokenBtn = document.getElementById('saveTokenBtn');

        function getToken() {
            return localStorage.getItem(tokenKey) || '';
        }

        function ensureToken() {
            const token = getToken();
            if (!token) {
                alert('请先设置 authToken。');
                return null;
            }
            return token;
        }

        saveTokenBtn.onclick = () => {
            const val = (tokenInput.value || '').trim();
            if (!val) return;
            localStorage.setItem(tokenKey, val);
            tokenInput.value = '';
            alert('Token 已保存');
        };

        pickBtn.onclick = () => fileInput.click();
        pasteBtn.onclick = () => {
            alert('请使用系统粘贴（Ctrl/Command + V）到页面');
        };

        fileInput.onchange = () => handleFiles(fileInput.files);

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag');
            if (e.dataTransfer && e.dataTransfer.files) {
                handleFiles(e.dataTransfer.files);
            }
        });

        document.addEventListener('paste', (e) => {
            const items = e.clipboardData ? e.clipboardData.items : [];
            const files = [];
            for (const item of items) {
                if (item.kind === 'file') {
                    const file = item.getAsFile();
                    if (file) files.push(file);
                }
            }
            if (files.length) handleFiles(files);
        });

        function handleFiles(fileList) {
            const token = ensureToken();
            if (!token) return;
            Array.from(fileList).forEach(file => queueUpload(file, token));
        }

        function queueUpload(file, token) {
            const item = document.createElement('div');
            item.className = 'queue-item';
            item.innerHTML = `
                <div style="display:flex;justify-content:space-between;gap:8px;">
                    <div>
                        <div style="font-weight:600;">${file.name}</div>
                        <div class="muted">${formatSize(file.size)}</div>
                    </div>
                    <div class="muted" id="status">准备中</div>
                </div>
                <div class="bar"><span></span></div>
            `;
            uploadQueue.prepend(item);
            const bar = item.querySelector('.bar span');
            const status = item.querySelector('#status');

            uploadFile(file, token, (p) => {
                bar.style.width = `${p}%`;
                status.textContent = `上传中 ${p}%`;
            }).then((data) => {
                bar.style.width = '100%';
                status.textContent = '完成';
                const id = data?.data?.id;
                if (id) addRecent(file, id, token);
            }).catch((err) => {
                status.textContent = '失败';
                status.style.color = '#fb7185';
                console.error(err);
            });
        }

        function uploadFile(file, token, onProgress) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const form = new FormData();
                form.append('file', file, file.name);
                xhr.open('POST', '/api/v1/cloud/upload', true);
                xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                xhr.upload.onprogress = (e) => {
                    if (!e.lengthComputable) return;
                    const percent = Math.round((e.loaded / e.total) * 100);
                    onProgress(percent);
                };
                xhr.onload = () => {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            resolve(JSON.parse(xhr.responseText));
                        } catch (err) {
                            reject(err);
                        }
                    } else {
                        reject(new Error(xhr.responseText || 'Upload failed'));
                    }
                };
                xhr.onerror = () => reject(new Error('Network error'));
                xhr.send(form);
            });
        }

        function addRecent(file, id, token) {
            if (recentList.querySelector('.muted')) {
                recentList.innerHTML = '';
            }
            const row = document.createElement('div');
            row.className = 'recent-item';
            row.innerHTML = `
                <div>
                    <div style="font-weight:600;">${file.name}</div>
                    <div class="muted">${formatSize(file.size)}</div>
                </div>
                <div>
                    <a href="/api/v1/cloud/items/${id}/download?token=${token}" target="_blank">打开</a>
                </div>
            `;
            recentList.prepend(row);
        }

        function formatSize(bytes) {
            if (!bytes) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
        }
    </script>
</body>
</html>
