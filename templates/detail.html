<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsightVault | è¯¦æƒ…</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Playfair+Display:wght@600&display=swap');
        :root {
            --bg-1: #f8f2e7;
            --bg-2: #e8f4f1;
            --ink: #1b1f23;
            --muted: #667085;
            --primary: #0e7c7b;
            --accent: #f76c4f;
            --card: rgba(255, 255, 255, 0.9);
            --line: rgba(20, 20, 20, 0.08);
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Space Grotesk', sans-serif;
            color: var(--ink);
            background:
                radial-gradient(circle at 10% 20%, rgba(247, 108, 79, 0.15), transparent 40%),
                radial-gradient(circle at 80% 10%, rgba(14, 124, 123, 0.18), transparent 35%),
                linear-gradient(160deg, var(--bg-1), var(--bg-2));
            min-height: 100vh;
        }
        .wrap { max-width: 900px; margin: 0 auto; padding: 42px 20px 80px; }
        .nav {
            display: flex; align-items: center; justify-content: space-between; gap: 16px;
            margin-bottom: 28px;
        }
        .brand {
            font-family: 'Playfair Display', serif;
            font-size: 26px; letter-spacing: 0.5px;
        }
        .nav-links {
            display: flex;
            gap: 16px;
        }
        .nav-links a {
            color: var(--ink); text-decoration: none; font-weight: 600;
        }
        .user-pill {
            padding: 6px 10px; border-radius: 999px; background: #fff; border: 1px solid var(--line);
            font-size: 12px; color: var(--muted);
        }
        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 12px 30px rgba(14, 124, 123, 0.08);
            animation: rise 0.6s ease-out;
            margin-bottom: 24px;
        }
        .detail-grid {
            display: grid;
            grid-template-columns: minmax(0, 1fr) 280px;
            gap: 20px;
        }
        .detail-side .card {
            position: sticky;
            top: 20px;
        }
        .related-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--line);
        }
        .related-item:last-child {
            border-bottom: none;
        }
        .related-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--ink);
            text-decoration: none;
        }
        .related-meta {
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px;
        }
        .detail-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 16px 0;
            color: var(--ink);
        }
        .detail-meta {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--line);
        }
        .detail-meta span {
            margin-right: 16px;
        }
        .tag {
            font-size: 11px; background: #f0f0f0; padding: 3px 8px; border-radius: 6px; margin-right: 6px;
            display: inline-block;
        }
        .status-pending { font-size: 11px; color: var(--muted); background: #eee; padding: 3px 8px; border-radius: 6px; display: inline-block; }
        .status-failed { font-size: 11px; color: #fff; background: var(--accent); padding: 3px 8px; border-radius: 6px; display: inline-block; }
        .detail-content {
            line-height: 1.7;
            font-size: 15px;
        }
        /* Markdownæ ·å¼ */
        .detail-content h1 { font-size: 24px; margin: 24px 0 12px; }
        .detail-content h2 { font-size: 20px; margin: 20px 0 10px; }
        .detail-content h3 { font-size: 18px; margin: 18px 0 8px; }
        .detail-content p { margin: 12px 0; }
        .detail-content pre {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
        .detail-content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .detail-content pre code {
            background: none;
            padding: 0;
        }
        .detail-content blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--muted);
        }
        .detail-content ul, .detail-content ol {
            padding-left: 24px;
        }
        .detail-content a {
            color: var(--primary);
            text-decoration: none;
        }
        .detail-content a:hover {
            text-decoration: underline;
        }
        .detail-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 16px 0;
        }
        .detail-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }
        .detail-content table th,
        .detail-content table td {
            border: 1px solid var(--line);
            padding: 8px;
            text-align: left;
        }
        .detail-content table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        
        .multimodal-info {
            background: #f0f7f6;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }
        .file-icon { font-size: 32px; flex-shrink: 0; }
        .file-details { flex: 1; }
        .file-name { font-weight: 600; font-size: 16px; color: var(--primary); margin-bottom: 4px; }
        .file-meta { font-size: 12px; color: var(--muted); }
        .metadata-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 10px; 
            margin-top: 10px;
            background: rgba(255,255,255,0.5);
            padding: 10px;
            border-radius: 8px;
        }
        .metadata-item { font-size: 11px; }
        .metadata-label { font-weight: 600; color: var(--muted); margin-right: 4px; }
        
        button {
            padding: 10px 16px; border-radius: 10px; border: 1px solid transparent;
            font-weight: 600; cursor: pointer; font-family: inherit;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-accent { background: var(--accent); color: #fff; }
        .btn-ghost { background: transparent; border-color: var(--ink); color: var(--ink); }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-small { font-size: 12px; padding: 6px 10px; }
        .muted { color: var(--muted); font-size: 12px; }
        
        .actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .edit-form {
            display: none;
        }
        .edit-form input,
        .edit-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--line);
            border-radius: 10px;
            font-size: 14px;
            background: #fff;
            outline: none;
            font-family: inherit;
            margin-bottom: 12px;
        }
        .edit-form textarea {
            min-height: 300px;
            resize: vertical;
        }
        
        .toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            background: var(--ink); color: #fff; padding: 10px 20px; border-radius: 12px;
            font-size: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 2000; animation: toastIn 0.3s ease-out;
        }
        @keyframes toastIn { from { bottom: 0; opacity: 0; } to { bottom: 24px; opacity: 1; } }
        @keyframes rise { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 700px) {
            .nav { flex-direction: column; align-items: flex-start; }
            .actions { flex-wrap: wrap; }
            .card { padding: 18px; }
            .detail-title { font-size: 22px; }
            .detail-grid { grid-template-columns: 1fr; }
            .detail-side .card { position: static; }
        }
    </style>
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- DOMPurify for XSS protection -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
</head>
<body>
    <div class="wrap">
        <div class="nav">
            <div>
                <div class="brand">InsightVault</div>
                <div class="muted">æƒ…æŠ¥è¯¦æƒ…</div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <span class="user-pill" id="userPill">æœªç™»å½•</span>
                <span class="nav-links">
                    <a href="/">é¦–é¡µ</a>
                    <a href="/app">åº”ç”¨</a>
                    <a href="/reading">ç¨åé˜…è¯»</a>
                    <a href="/cloud">äº‘ç›˜</a>
                    <a href="/groups">å›¢é˜Ÿ</a>
                    <a href="/settings">è®¾ç½®</a>
                    <a href="/login" onclick="logout()">é€€å‡º</a>
                </span>
            </div>
        </div>

        <div class="detail-grid">
            <div class="detail-main">
                <div id="viewMode">
                    <div class="card">
                        <div class="actions">
                            <button class="btn-primary" onclick="switchToEditMode()">ç¼–è¾‘</button>
                            <button class="btn-accent" onclick="analyzeDeeply()">ğŸ¤” æ·±åº¦åˆ†æ</button>
                            <button class="btn-accent btn-small" id="favoriteBtn" onclick="toggleFavorite()">â­ æ”¶è—</button>
                            <button class="btn-ghost btn-small" id="archiveBtn" onclick="toggleArchive()">ğŸ“¦ å½’æ¡£</button>
                            <button class="btn-danger" onclick="deleteItem()">åˆ é™¤</button>
                            <button class="btn-ghost" onclick="goBack()">è¿”å›</button>
                        </div>
                        <h1 class="detail-title" id="itemTitle">åŠ è½½ä¸­...</h1>
                        <div class="detail-meta" id="itemMeta"></div>
                        
                        <div id="multimodalInfoArea"></div>
                        
                        <div class="detail-content" id="itemContent"></div>
                    </div>
                </div>

                <div id="editMode" class="edit-form">
                    <div class="card">
                        <h2>ç¼–è¾‘æƒ…æŠ¥</h2>
                        <input type="text" id="editTitle" placeholder="æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰">
                        <textarea id="editContent" placeholder="å†…å®¹ï¼ˆæ”¯æŒMarkdownæ ¼å¼ï¼‰"></textarea>
                        <input type="text" id="editTags" placeholder="æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰">
                        <div style="display: flex; gap: 12px; margin-top: 12px;">
                            <button class="btn-primary" onclick="saveEdit()">ä¿å­˜</button>
                            <button class="btn-ghost" onclick="cancelEdit()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
            <aside class="detail-side">
                <div class="card">
                    <h3 style="margin-top: 0;">ç›¸å…³æƒ…æŠ¥</h3>
                    <div id="relatedAction">
                        <button class="btn-primary btn-small" onclick="loadRelated()" style="width: 100%; margin-bottom: 12px;">ğŸ” æŸ¥æ‰¾å…³è”æƒ…æŠ¥</button>
                    </div>
                    <div id="relatedList" class="muted"></div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken') || '';
        let currentUser = null;
        let currentItem = null;
        let itemId = null;

        // é…ç½®markedå’ŒDOMPurify
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: true,
            mangle: false
        });

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('authUser');
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = { method };
                if (body) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(body);
                }
                if (authToken) {
                    options.headers = options.headers || {};
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                }
                const res = await fetch(endpoint, options);
                if (res.status === 401) {
                    logout();
                    window.location.href = '/login';
                    return null;
                }
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(errorText || `HTTP ${res.status}`);
                }
                return await res.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function loadMe() {
            const res = await apiCall('/api/auth/me');
            if (!res || !res.user) return;
            currentUser = res.user;
            document.getElementById('userPill').innerText = currentUser.name || currentUser.email;
        }

        async function loadItem() {
            try {
                const res = await apiCall(`/api/v1/items/${itemId}`);
                if (!res || !res.data) {
                    showToast('åŠ è½½å¤±è´¥');
                    return;
                }
                
                currentItem = res.data;
                
                // æ˜¾ç¤ºæ ‡é¢˜
                const titleEl = document.getElementById('itemTitle');
                titleEl.textContent = currentItem.title || 'æ— æ ‡é¢˜';
                
                // æ˜¾ç¤ºå…ƒæ•°æ®
                const metaEl = document.getElementById('itemMeta');
                const createdAt = new Date(currentItem.created_at).toLocaleString('zh-CN');
                const visTag = currentItem.visibility === 'group'
                    ? `<span class="tag">å›¢é˜Ÿ: ${currentItem.group_name || 'æœªå‘½å'}</span>`
                    : `<span class="tag">ç§æœ‰</span>`;
                
                let statusHtml = '';
                if (currentItem.vectorization_status === 'pending') {
                    statusHtml = `<span class="status-pending">âŒ› å‘é‡åŒ–ä¸­...</span>`;
                } else if (currentItem.vectorization_status === 'failed') {
                    statusHtml = `<span class="status-failed">âš  å‘é‡åŒ–å¤±è´¥</span>`;
                }

                const tags = (currentItem.tags || []).map(t => `<span class="tag">#${t}</span>`).join(' ');
                const favoriteIcon = currentItem.is_favorited ? 'â­ ' : '';
                const archivedBadge = currentItem.is_archived ? '<span class="tag" style="background: var(--muted); color: white;">ğŸ“¦ å·²å½’æ¡£</span>' : '';
                metaEl.innerHTML = `
                    <span>åˆ›å»ºäº: ${createdAt}</span>
                    <span>ä½œè€…: ${currentItem.owner_name || 'æœªçŸ¥'}</span>
                    ${visTag}
                    ${statusHtml}
                    ${archivedBadge}
                    ${tags}
                `;
                
                // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºæ”¶è—çŠ¶æ€
                titleEl.textContent = (favoriteIcon ? favoriteIcon : '') + (currentItem.title || 'æ— æ ‡é¢˜');
                
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                updateActionButtons();
                
                // å¤„ç†å¤šæ¨¡æ€æºæ–‡ä»¶å±•ç¤º
                const mmArea = document.getElementById('multimodalInfoArea');
                if (currentItem.source_file_id) {
                    const metadata = currentItem.source_metadata || {};
                    let metadataHtml = '';
                    for (const [key, value] of Object.entries(metadata)) {
                        if (value && typeof value !== 'object') {
                            metadataHtml += `<div class="metadata-item"><span class="metadata-label">${key}:</span>${value}</div>`;
                        }
                    }

                    mmArea.innerHTML = `
                        <div class="multimodal-info">
                            <div class="file-icon">ğŸ“„</div>
                            <div class="file-details">
                                <div class="file-name">${currentItem.source_filename}</div>
                                <div class="file-meta">
                                    ç±»å‹: ${currentItem.source_mime_type} | 
                                    <a href="/api/v1/cloud/items/${currentItem.source_file_id}/download" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">ä¸‹è½½åŸå§‹æ–‡ä»¶</a>
                                </div>
                                ${metadataHtml ? `<div class="metadata-grid">${metadataHtml}</div>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    mmArea.innerHTML = '';
                }
                
                // æ¸²æŸ“Markdownå†…å®¹å¹¶æ¸…ç†XSS
                const contentEl = document.getElementById('itemContent');
                const rawHtml = marked.parse(currentItem.content);
                const cleanHtml = DOMPurify.sanitize(rawHtml, {
                    ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'u', 's', 'a', 'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'img', 'hr'],
                    ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class']
                });
                contentEl.innerHTML = cleanHtml;
            } catch (error) {
                showToast('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        function renderRelatedList(container, items, emptyText) {
            if (!items || items.length === 0) {
                container.innerHTML = `<div class="muted">${emptyText}</div>`;
                return;
            }
            container.innerHTML = '';
            items.forEach(item => {
                const createdAt = item.created_at ? new Date(item.created_at).toLocaleDateString('zh-CN') : '';
                const score = item.score ? `${Math.round(item.score * 100)}%` : '';
                const div = document.createElement('div');
                div.className = 'related-item';
                div.innerHTML = `
                    <a class="related-title" href="/detail?id=${item.id}">${item.title || 'æ— æ ‡é¢˜'}</a>
                    <div class="related-meta">${createdAt}${score ? ` Â· ç›¸ä¼¼åº¦ ${score}` : ''}</div>
                `;
                container.appendChild(div);
            });
        }

        async function loadRelated() {
            const btn = document.querySelector('#relatedAction button');
            if (btn) btn.disabled = true;
            document.getElementById('relatedList').innerHTML = 'æ­£åœ¨åˆ†æå…³è”æ€§...';
            
            try {
                // limit=10 (ä¸å†è¯·æ±‚å¯¹ç«‹è§‚ç‚¹)
                const res = await apiCall(`/api/v1/items/${itemId}/related?limit=10`);
                if (res && res.data) {
                    const relatedList = document.getElementById('relatedList');
                    renderRelatedList(relatedList, res.data.related, 'æš‚æ— å‘ç°é«˜åº¦å…³è”çš„æƒ…æŠ¥');
                    if (btn) btn.style.display = 'none'; // åŠ è½½æˆåŠŸåéšè—æŒ‰é’®
                } else {
                    document.getElementById('relatedList').innerHTML = '<div class="muted">åŠ è½½å¤±è´¥</div>';
                    if (btn) btn.disabled = false;
                }
            } catch (e) {
                console.error('åŠ è½½ç›¸å…³æƒ…æŠ¥å¤±è´¥:', e);
                document.getElementById('relatedList').innerHTML = '<div class="muted">åŠ è½½å¤±è´¥</div>';
                if (btn) btn.disabled = false;
            }
        }

        async function analyzeDeeply() {
            const contentEl = document.getElementById('itemContent');
            const originalContent = contentEl.innerHTML;
            
            // æ’å…¥åŠ è½½æç¤º
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'card';
            loadingDiv.style.background = '#f0f9ff';
            loadingDiv.style.borderLeft = '4px solid #0e7c7b';
            loadingDiv.style.marginTop = '20px';
            loadingDiv.innerHTML = `
                <div style="font-weight:600; color:#0e7c7b; margin-bottom:8px;">ğŸ¤” æ­£åœ¨è¿›è¡Œæ·±åº¦é€»è¾‘åˆ†æ...</div>
                <div class="muted">æ­£åœ¨æŒ–æ˜ä¸ç¡®å®šæ€§ã€æ ¸å¿ƒå‡è®¾åŠè¡ŒåŠ¨å»ºè®®...</div>
            `;
            contentEl.appendChild(loadingDiv);
            loadingDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

            try {
                const res = await apiCall(`/api/v1/items/${itemId}/analyze`);
                if (res && res.data) {
                    loadingDiv.innerHTML = `
                        <div style="font-weight:600; color:#0e7c7b; margin-bottom:12px; display:flex; justify-content:space-between;">
                            <span>ğŸ¤” æ·±åº¦åˆ†ææŠ¥å‘Š</span>
                            <button class="btn-ghost btn-small" onclick="this.parentElement.parentElement.remove()">å…³é—­</button>
                        </div>
                        <div style="font-size:14px; line-height:1.6;">${marked.parse(res.data)}</div>
                    `;
                } else {
                    loadingDiv.innerHTML = '<div class="muted">åˆ†æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                }
            } catch (e) {
                loadingDiv.innerHTML = '<div class="muted">å‘ç”Ÿé”™è¯¯ï¼š' + e.message + '</div>';
            }
        }

        function switchToEditMode() {
            document.getElementById('viewMode').style.display = 'none';
            document.getElementById('editMode').style.display = 'block';
            
            document.getElementById('editTitle').value = currentItem.title || '';
            document.getElementById('editContent').value = currentItem.content || '';
            document.getElementById('editTags').value = (currentItem.tags || []).join(', ');
        }

        function cancelEdit() {
            document.getElementById('viewMode').style.display = 'block';
            document.getElementById('editMode').style.display = 'none';
        }

        async function saveEdit() {
            const title = document.getElementById('editTitle').value.trim();
            const content = document.getElementById('editContent').value.trim();
            const tags = document.getElementById('editTags').value;
            
            if (!content) {
                alert('å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                const res = await apiCall(`/api/v1/items/${itemId}`, 'PUT', {
                    title,
                    content,
                    visibility: currentItem.visibility,
                    group_id: currentItem.group_id,
                    tags
                });
                
                if (res && res.status === 'success') {
                    showToast('âœ“ ä¿å­˜æˆåŠŸ');
                    await loadItem();
                    cancelEdit();
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        async function deleteItem() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æƒ…æŠ¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
            
            try {
                const res = await apiCall(`/api/v1/items/${itemId}`, 'DELETE');
                if (res && res.status === 'success') {
                    showToast('âœ“ å·²åˆ é™¤');
                    setTimeout(() => {
                        window.location.href = '/app';
                    }, 1000);
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        function updateActionButtons() {
            if (!currentItem) return;
            
            const favoriteBtn = document.getElementById('favoriteBtn');
            const archiveBtn = document.getElementById('archiveBtn');
            
            if (favoriteBtn) {
                favoriteBtn.textContent = currentItem.is_favorited ? 'â­ å–æ¶ˆæ”¶è—' : 'â­ æ”¶è—';
                favoriteBtn.className = currentItem.is_favorited ? 'btn-accent btn-small' : 'btn-ghost btn-small';
            }
            
            if (archiveBtn) {
                archiveBtn.textContent = currentItem.is_archived ? 'ğŸ“¦ å–æ¶ˆå½’æ¡£' : 'ğŸ“¦ å½’æ¡£';
            }
        }

        async function toggleFavorite() {
            if (!currentItem) return;
            
            try {
                const newStatus = !currentItem.is_favorited;
                const res = await apiCall(`/api/v1/items/${itemId}/status`, 'PATCH', {
                    is_favorited: newStatus
                });
                
                if (res && res.status === 'success') {
                    currentItem.is_favorited = newStatus;
                    showToast(newStatus ? 'â­ å·²æ”¶è—' : 'å·²å–æ¶ˆæ”¶è—');
                    await loadItem();
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function toggleArchive() {
            if (!currentItem) return;
            
            try {
                const newStatus = !currentItem.is_archived;
                const res = await apiCall(`/api/v1/items/${itemId}/status`, 'PATCH', {
                    is_archived: newStatus
                });
                
                if (res && res.status === 'success') {
                    currentItem.is_archived = newStatus;
                    showToast(newStatus ? 'ğŸ“¦ å·²å½’æ¡£' : 'å·²å–æ¶ˆå½’æ¡£');
                    await loadItem();
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        function goBack() {
            window.history.back();
        }

        window.onload = async () => {
            if (!authToken) {
                window.location.href = '/login';
                return;
            }
            
            // ä»URLè·å–item_id
            const params = new URLSearchParams(window.location.search);
            itemId = params.get('id');
            
            if (!itemId) {
                showToast('ç¼ºå°‘å‚æ•°');
                setTimeout(() => window.location.href = '/app', 1000);
                return;
            }
            
            await loadMe();
            await loadItem();
        };
    </script>
</body>
</html>
