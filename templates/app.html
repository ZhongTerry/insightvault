<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsightVault | åº”ç”¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Playfair+Display:wght@600&display=swap');
        :root {
            --bg-1: #f8f2e7;
            --bg-2: #e8f4f1;
            --ink: #1b1f23;
            --muted: #667085;
            --primary: #0e7c7b;
            --accent: #f76c4f;
            --card: rgba(255, 255, 255, 0.9);
            --line: rgba(20, 20, 20, 0.08);
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Space Grotesk', sans-serif;
            color: var(--ink);
            background:
                radial-gradient(circle at 10% 20%, rgba(247, 108, 79, 0.15), transparent 40%),
                radial-gradient(circle at 80% 10%, rgba(14, 124, 123, 0.18), transparent 35%),
                linear-gradient(160deg, var(--bg-1), var(--bg-2));
            min-height: 100vh;
        }
        .wrap { max-width: 1000px; margin: 0 auto; padding: 42px 20px 80px; }
        .nav {
            display: flex; align-items: center; justify-content: space-between; gap: 16px;
            margin-bottom: 28px;
        }
        .brand {
            font-family: 'Playfair Display', serif;
            font-size: 26px; letter-spacing: 0.5px;
        }
        .nav-links a {
            color: var(--ink); text-decoration: none; margin-left: 16px; font-weight: 600;
        }
        .user-pill {
            padding: 6px 10px; border-radius: 999px; background: #fff; border: 1px solid var(--line);
            font-size: 12px; color: var(--muted);
        }
        .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
        .row:last-of-type { margin-bottom: 0; }
        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 12px 30px rgba(14, 124, 123, 0.08);
            animation: rise 0.6s ease-out;
            margin-bottom: 18px;
        }
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--line); border-radius: 10px;
            font-size: 14px; background: #fff; outline: none; font-family: inherit;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .template-field {
            margin-bottom: 8px;
        }
        .template-field label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 4px;
        }
        .template-field input,
        .template-field textarea {
            margin-bottom: 0;
        }
        button {
            padding: 10px 16px; border-radius: 10px; border: 1px solid transparent;
            font-weight: 600; cursor: pointer;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-accent { background: var(--accent); color: #fff; }
        .btn-ghost { background: transparent; border-color: var(--ink); color: var(--ink); }
        .btn-small { font-size: 12px; padding: 6px 10px; }
        .muted { color: var(--muted); font-size: 12px; }
        .item { border-bottom: 1px solid var(--line); padding: 14px 4px; }
        .item:last-child { border-bottom: none; }
        .item-meta { font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; gap: 10px; }
        .tag { font-size: 11px; background: #f0f0f0; padding: 2px 6px; border-radius: 6px; margin-left: 6px; }
        .score { font-size: 11px; color: #0e7c7b; background: #e9f6f5; padding: 2px 6px; border-radius: 6px; }
        .status-pending { font-size: 11px; color: var(--muted); background: #eee; padding: 2px 6px; border-radius: 6px; }
        .status-failed { font-size: 11px; color: #fff; background: var(--accent); padding: 2px 6px; border-radius: 6px; }
        .pagination { display: flex; gap: 12px; align-items: center; justify-content: center; margin-top: 16px; }
        #loader { display: none; text-align: center; color: var(--primary); font-weight: 600; margin: 12px 0; }
        @keyframes rise { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        
        .toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            background: var(--ink); color: #fff; padding: 10px 20px; border-radius: 12px;
            font-size: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 2000; animation: toastIn 0.3s ease-out;
        }
        @keyframes toastIn { from { bottom: 0; opacity: 0; } to { bottom: 24px; opacity: 1; } }

        @media (max-width: 900px) {
            .wrap { padding: 24px 16px 60px; }
            .nav { flex-direction: column; align-items: flex-start; }
            .nav-links { display: flex; flex-wrap: wrap; gap: 10px; }
            .row { flex-direction: column; }
            .card { padding: 16px; }
            .item-meta { flex-direction: column; align-items: flex-start; }
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-card {
            background: var(--bg-1); width: 90%; max-width: 600px; padding: 24px;
            border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            max-height: 85vh; overflow-y: auto;
        }
        .tag-list-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid var(--line);
        }
        .tag-list-item:last-child { border-bottom: none; }

        @media (max-width: 700px) {
            .nav { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="nav">
            <div>
                <div class="brand">InsightVault</div>
                <div class="muted">ä½ çš„ä¸ªäººä¸å›¢é˜Ÿæƒ…æŠ¥ç©ºé—´</div>
            </div>
            <div>
                <span class="user-pill" id="userPill">æœªç™»å½•</span>
                <span class="nav-links">
                    <a href="/">é¦–é¡µ</a>
                    <a href="/reading">ç¨åé˜…è¯»</a>
                    <a href="/cloud">äº‘ç›˜</a>
                    <a href="/groups">å›¢é˜Ÿ</a>
                    <a href="#" onclick="openManageTagsModal()">æ ‡ç­¾ç®¡ç†</a>
                    <a href="/settings">è®¾ç½®</a>
                    <a href="/admin" id="adminLink" style="display: none;">ç®¡ç†</a>
                    <a href="/login" onclick="logout()">é€€å‡º</a>
                </span>
            </div>
        </div>

        <div class="card">
            <div class="row">
                <select id="templateSelect" onchange="onTemplateChange()" style="width: auto;">
                    <option value="none">æ— æ¨¡æ¿ï¼ˆè‡ªç”±è¾“å…¥ï¼‰</option>
                    <option value="item_entry">æ¡ç›®å¡«å……æ¨¡æ¿</option>
                    <option value="book_note">è¯»ä¹¦ç¬”è®°æ¨¡æ¿</option>
                    <option value="meeting_record">ä¼šè®®è®°å½•æ¨¡æ¿</option>
                    <option value="problem_record">é”™é¢˜è®°å½•æ¨¡æ¿</option>
                </select>
            </div>
            <div id="freeInputArea" class="row">
                <input id="addTitle" placeholder="æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰" style="margin-bottom: 8px;">
                <textarea id="addInput" placeholder="è®°å½•æ–°çš„çµæ„Ÿã€æƒ…æŠ¥æˆ–é“¾æ¥ï¼ˆæ”¯æŒMarkdownï¼‰..." onkeydown="handleKeydown(event, addData)"></textarea>
            </div>
            <div id="templateInputArea" style="display: none;">
                <!-- æ¨¡æ¿è¾“å…¥æ¡†å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="row">
                <input id="tagsInput" placeholder="æ ‡ç­¾ (é€—å·åˆ†éš”)">
                <select id="visibilitySelect" onchange="onVisibilityChange()">
                    <option value="private">ä»…è‡ªå·±</option>
                    <option value="group">å›¢é˜Ÿå…±äº«</option>
                </select>
                <select id="groupSelect" disabled>
                    <option value="">é€‰æ‹©å›¢é˜Ÿ</option>
                </select>
            </div>
            <button id="addBtn" class="btn-primary" onclick="addData()">å­˜å…¥æƒ…æŠ¥</button>
        </div>

        <div class="card">
            <textarea id="searchInput" placeholder="æœç´¢å·²å­˜å†…å®¹..." onkeydown="handleKeydown(event, () => doSearch('ai'))" style="margin-bottom: 12px;"></textarea>
            <div class="row">
                <button class="btn-primary" onclick="doSearch('ai')">AI æœç´¢</button>
                <button class="btn-accent" onclick="doSearch('key')">å…³é”®è¯</button>
                <button class="btn-ghost" onclick="doSearch('tag')">æ ‡ç­¾</button>
                <button class="btn-ghost" onclick="doSearch('all')">å…¨éƒ¨</button>
            </div>
            <div class="row" style="margin-top: 8px;">
                <button class="btn-ghost btn-small" onclick="toggleShowArchived()"><span id="archiveToggleText">ğŸ“¦ æ˜¾ç¤ºå½’æ¡£</span></button>
                <button class="btn-ghost btn-small" onclick="toggleFavoritedOnly()"><span id="favoriteToggleText">â­ ä»…çœ‹æ”¶è—</span></button>
                <button id="revectorizeBtn" class="btn-ghost btn-small" onclick="revectorizeAll()">é‡æ„å‘é‡</button>
            </div>
        </div>

        <div id="loader">å¤„ç†ä¸­...</div>
        <div class="card" id="results"></div>

        <div class="pagination">
            <button id="prevBtn" class="btn-ghost" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
            <span id="pageInfo" class="muted">ç¬¬ 1 é¡µ</span>
            <button id="nextBtn" class="btn-ghost" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- Manage Tags Modal -->
    <div id="manageTagsModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>æ ‡ç­¾ç®¡ç†</h3>
                <button class="btn-ghost btn-small" onclick="closeManageTagsModal()">å…³é—­</button>
            </div>
            <div id="tagsListContainer" style="margin-top: 16px;">
                <div class="muted">æ­£åœ¨åŠ è½½æ ‡ç­¾...</div>
            </div>
        </div>
    </div>

    <!-- Rename Tag Modal -->
    <div id="renameTagModal" class="modal-overlay" style="display: none; z-index: 1001;">
        <div class="modal-card" style="max-width: 400px;">
            <h3>é‡å‘½åæ ‡ç­¾</h3>
            <input id="renameTagNameInput" placeholder="æ–°çš„æ ‡ç­¾åç§°">
            <div class="row" style="justify-content: flex-end; margin-top: 12px;">
                <button class="btn-ghost" onclick="closeRenameTagModal()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="saveTagName()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentType = 'all';
        let currentQuery = '';
        let currentShowArchived = false;
        let currentFavoritedOnly = false;
        let authToken = localStorage.getItem('authToken') || '';
        let currentUser = null;
        let currentGroups = [];
        let currentTemplate = 'none';

        // æ¨¡æ¿é…ç½®
        const templates = {
            none: {
                name: 'æ— æ¨¡æ¿ï¼ˆè‡ªç”±è¾“å…¥ï¼‰',
                fields: []
            },
            item_entry: {
                name: 'æ¡ç›®å¡«å……æ¨¡æ¿',
                fields: [
                    { key: 'name', label: 'åç§°', type: 'input', placeholder: 'è¾“å…¥æ¡ç›®åç§°' },
                    { key: 'category', label: 'åˆ†ç±»', type: 'input', placeholder: 'è¾“å…¥åˆ†ç±»' },
                    { key: 'detail', label: 'è¯¦ç»†è¯´æ˜', type: 'textarea', placeholder: 'è¾“å…¥è¯¦ç»†ä¿¡æ¯' }
                ],
                format: (data) => ({
                    title: `æ¡ç›®ï¼š${data.name}`,
                    content: `${data.name} æ˜¯ä¸€ä¸ªå…³äº ${data.category} çš„æ¡ç›®ï¼Œå…·ä½“ç»†èŠ‚å¦‚ä¸‹ï¼š\n\n${data.detail}`
                })
            },
            book_note: {
                name: 'è¯»ä¹¦ç¬”è®°æ¨¡æ¿',
                fields: [
                    { key: 'book_title', label: 'ä¹¦å', type: 'input', placeholder: 'è¾“å…¥ä¹¦å' },
                    { key: 'author', label: 'ä½œè€…', type: 'input', placeholder: 'è¾“å…¥ä½œè€…' },
                    { key: 'chapter', label: 'ç« èŠ‚', type: 'input', placeholder: 'ç¬¬å‡ ç« æˆ–é¡µç ' },
                    { key: 'quote', label: 'æ‘˜å½•', type: 'textarea', placeholder: 'ä¹¦ä¸­çš„åŸæ–‡æˆ–è¦ç‚¹' },
                    { key: 'reflection', label: 'æ„Ÿæ‚Ÿ', type: 'textarea', placeholder: 'ä½ çš„æ€è€ƒå’Œå¿ƒå¾—' }
                ],
                format: (data) => ({
                    title: `è¯»ã€Š${data.book_title}ã€‹æœ‰æ„Ÿ`,
                    content: `## è¯»ä¹¦ç¬”è®°\n\n**ä¹¦å**ï¼š${data.book_title}\n**ä½œè€…**ï¼š${data.author}\n**ç« èŠ‚**ï¼š${data.chapter}\n\n### æ‘˜å½•\n> ${data.quote}\n\n### æˆ‘çš„æ„Ÿæ‚Ÿ\n${data.reflection}`
                })
            },
            meeting_record: {
                name: 'ä¼šè®®è®°å½•æ¨¡æ¿',
                fields: [
                    { key: 'meeting_title', label: 'ä¼šè®®ä¸»é¢˜', type: 'input', placeholder: 'è¾“å…¥ä¼šè®®ä¸»é¢˜' },
                    { key: 'date', label: 'æ—¥æœŸ', type: 'input', placeholder: 'ä¼šè®®æ—¥æœŸ' },
                    { key: 'participants', label: 'å‚ä¼šäººå‘˜', type: 'input', placeholder: 'å‚ä¼šäººå‘˜åå•' },
                    { key: 'summary', label: 'ä¼šè®®è¦ç‚¹', type: 'textarea', placeholder: 'è®¨è®ºçš„ä¸»è¦å†…å®¹' },
                    { key: 'action_items', label: 'è¡ŒåŠ¨é¡¹', type: 'textarea', placeholder: 'å¾…åŠäº‹é¡¹å’Œè´£ä»»äºº' }
                ],
                format: (data) => ({
                    title: `ä¼šè®®è®°å½•ï¼š${data.meeting_title}`,
                    content: `## ä¼šè®®ä¿¡æ¯\n- **æ—¥æœŸ**ï¼š${data.date}\n- **ä¸»è¦äººå‘˜**ï¼š${data.participants}\n\n## ä¼šè®®è¦ç‚¹\n${data.summary}\n\n## è¡ŒåŠ¨é¡¹\n${data.action_items}`
                })
            },
            problem_record: {
                name: 'é”™é¢˜è®°å½•æ¨¡æ¿',
                fields: [
                    { key: 'subject', label: 'ç§‘ç›®/é¢†åŸŸ', type: 'input', placeholder: 'å¦‚ï¼šæ•°å­¦ã€å‰ç«¯ã€åç«¯ç­‰' },
                    { key: 'question', label: 'é¢˜ç›®æè¿°', type: 'textarea', placeholder: 'è¯¦ç»†è®°å½•é”™é¢˜å†…å®¹' },
                    { key: 'wrong_reason', label: 'é”™è¯¯åŸå› ', type: 'input', placeholder: 'å¦‚ï¼šæ¦‚å¿µä¸æ¸…ã€ç²—å¿ƒã€é€»è¾‘é”™è¯¯ç­‰' },
                    { key: 'solution', label: 'è§£æä¸æ€»ç»“', type: 'textarea', placeholder: 'æ­£ç¡®è§£æ³•ã€ç›¸å…³çŸ¥è¯†ç‚¹åŠé¿å‘æŒ‡å—' }
                ],
                format: (data) => ({
                    title: `ã€é”™é¢˜æœ¬ã€‘${data.subject} - ${data.question.substring(0, 15)}...`,
                    content: `### é¢˜ç›®å†…å®¹\n${data.question}\n\n### é”™è¯¯åŸå› \n${data.wrong_reason}\n\n### æ­£ç¡®è§£æä¸æ€»ç»“\n${data.solution}`
                })
            }
        };

        function onTemplateChange() {
            const templateKey = document.getElementById('templateSelect').value;
            currentTemplate = templateKey;
            const template = templates[templateKey];
            
            const freeArea = document.getElementById('freeInputArea');
            const templateArea = document.getElementById('templateInputArea');
            
            if (templateKey === 'none') {
                freeArea.style.display = 'flex';
                templateArea.style.display = 'none';
            } else {
                freeArea.style.display = 'none';
                templateArea.style.display = 'block';
                
                // åŠ¨æ€ç”Ÿæˆæ¨¡æ¿è¾“å…¥æ¡†
                templateArea.innerHTML = '';
                template.fields.forEach(field => {
                    const div = document.createElement('div');
                    div.className = 'template-field';
                    const label = document.createElement('label');
                    label.textContent = field.label;
                    div.appendChild(label);
                    
                    if (field.type === 'textarea') {
                        const textarea = document.createElement('textarea');
                        textarea.id = `tmpl_${field.key}`;
                        textarea.placeholder = field.placeholder;
                        textarea.style.minHeight = '60px';
                        div.appendChild(textarea);
                    } else {
                        const input = document.createElement('input');
                        input.id = `tmpl_${field.key}`;
                        input.placeholder = field.placeholder;
                        div.appendChild(input);
                    }
                    
                    templateArea.appendChild(div);
                });
            }
        }

        function getTemplateContent() {
            if (currentTemplate === 'none') {
                return {
                    title: document.getElementById('addTitle').value.trim() || 'æœªå‘½å intelligence',
                    content: document.getElementById('addInput').value.trim()
                };
            }
            
            const template = templates[currentTemplate];
            const data = {};
            
            // æ”¶é›†æ¨¡æ¿å­—æ®µæ•°æ®
            for (const field of template.fields) {
                const elem = document.getElementById(`tmpl_${field.key}`);
                const value = elem ? elem.value.trim() : '';
                if (!value) {
                    alert(`è¯·å¡«å†™ã€Œ${field.label}ã€`);
                    return null;
                }
                data[field.key] = value;
            }
            
            // ä½¿ç”¨æ¨¡æ¿æ ¼å¼åŒ–å‡½æ•°ç”Ÿæˆæ ‡é¢˜å’Œå†…å®¹
            return template.format(data);
        }

        function clearTemplateInputs() {
            document.getElementById('addTitle').value = '';
            if (currentTemplate === 'none') {
                document.getElementById('addInput').value = '';
            } else {
                const template = templates[currentTemplate];
                template.fields.forEach(field => {
                    const elem = document.getElementById(`tmpl_${field.key}`);
                    if (elem) elem.value = '';
                });
            }
        }

        function handleKeydown(e, callback) {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                callback();
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('authUser');
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            try {
                const options = { method };
                if (body) {
                    options.headers = { 'Content-Type': 'application/json' };
                    options.body = JSON.stringify(body);
                }
                if (authToken) {
                    options.headers = options.headers || {};
                    options.headers['Authorization'] = `Bearer ${authToken}`;
                }
                const res = await fetch(endpoint, options);
                if (res.status === 401) {
                    logout();
                    window.location.href = '/login';
                    return null;
                }
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error(`API Error [${res.status}]:`, errorText);
                    alert(`è¯·æ±‚å¤±è´¥ (${res.status}): ${errorText.substring(0, 100)}`);
                    return null;
                }
                return await res.json();
            } catch (error) {
                console.error('Network error:', error);
                alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œã€‚\n\næç¤º: è¿è¡Œ py main.py web å¯åŠ¨æœåŠ¡å™¨');
                return null;
            }
        }

        async function loadMe() {
            const res = await apiCall('/api/auth/me');
            if (!res || !res.user) return;
            currentUser = res.user;
            document.getElementById('userPill').innerText = currentUser.name || currentUser.email;
            const isAdmin = currentUser.role === 'admin';
            document.getElementById('revectorizeBtn').style.display = isAdmin ? 'inline-block' : 'none';
            if (isAdmin) {
                document.getElementById('adminLink').style.display = 'inline';
            }
        }

        async function loadGroups() {
            const res = await apiCall('/api/groups');
            currentGroups = (res && res.groups) ? res.groups : [];
            const select = document.getElementById('groupSelect');
            select.innerHTML = '<option value="">é€‰æ‹©å›¢é˜Ÿ</option>';
            currentGroups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.group_id;
                opt.textContent = `${g.name} (${g.role})`;
                select.appendChild(opt);
            });
        }

        function onVisibilityChange() {
            const visibility = document.getElementById('visibilitySelect').value;
            const groupSelect = document.getElementById('groupSelect');
            groupSelect.disabled = visibility !== 'group';
        }

        async function render(type, q, page) {
            currentType = type;
            currentQuery = q;
            currentPage = page;

            document.getElementById('loader').style.display = 'block';
            const showArchivedParam = currentShowArchived ? 'true' : 'false';
            const favoritedOnlyParam = currentFavoritedOnly ? 'true' : 'false';
            const res = await apiCall(`/api/v1/items?type=${type}&q=${encodeURIComponent(q)}&page=${page}&per_page=10&show_archived=${showArchivedParam}&favorited_only=${favoritedOnlyParam}`);
            const container = document.getElementById('results');
            document.getElementById('loader').style.display = 'none';

            if (!res || !res.data) {
                container.innerHTML = '<div class="muted">åŠ è½½å¤±è´¥</div>';
                return;
            }
            
            const data = res.data;
            container.innerHTML = data.length ? '' : '<div class="muted">æ— å†…å®¹</div>';

            data.forEach(item => {
                const createdAt = new Date(item.created_at).toLocaleString('zh-CN');
                const scoreStr = item.score ? `<span class="score">åŒ¹é…åº¦ ${(item.score * 100).toFixed(1)}%</span>` : '';
                
                let statusStr = '';
                if (item.vectorization_status === 'pending') {
                    statusStr = `<span class="status-pending">âŒ› å‘é‡åŒ–ä¸­...</span>`;
                } else if (item.vectorization_status === 'failed') {
                    statusStr = `<span class="status-failed">âš  å‘é‡åŒ–å¤±è´¥</span>`;
                }

                const itemEl = document.createElement('div');
                itemEl.className = 'item';
                itemEl.id = `item-${item.id}`;
                itemEl.style.cursor = 'pointer';
                itemEl.onclick = () => viewDetail(item.id);
                
                const favoriteIcon = item.is_favorited ? 'â­ ' : '';
                const archivedBadge = item.is_archived ? '<span class="tag" style="background: var(--muted); color: white;">ğŸ“¦ å·²å½’æ¡£</span>' : '';
                
                // åˆ›å»ºç»“æ„
                itemEl.innerHTML = `
                    <div class="item-title" style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">${favoriteIcon}<span class="title-text"></span></div>
                    <div class="item-preview" style="color: var(--muted); margin-bottom: 8px;"></div>
                    <div class="item-meta" style="font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>${createdAt}</span>
                            ${scoreStr}
                            ${statusStr}
                            ${archivedBadge}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="vis-pill"></span>
                            <span class="tags-container"></span>
                        </div>
                    </div>
                `;
                
                // å¡«å……çº¯æ–‡æœ¬å†…å®¹ï¼ˆé˜²XSSï¼‰
                const titleElem = itemEl.querySelector('.title-text');
                if (titleElem) {
                    titleElem.textContent = item.title || 'æ— æ ‡é¢˜';
                }
                itemEl.querySelector('.item-preview').textContent = (item.content_preview || item.content || '') + '...';
                
                // å¡«å……å¯è§æ€§
                const visPill = itemEl.querySelector('.vis-pill');
                visPill.className = 'tag';
                visPill.textContent = item.visibility === 'group' ? `å›¢é˜Ÿ: ${item.group_name || 'æœªå‘½å'}` : 'ç§æœ‰';
                
                // å¡«å……æ ‡ç­¾
                const tagsContainer = itemEl.querySelector('.tags-container');
                const tagsArr = Array.isArray(item.tags) ? item.tags : [];
                tagsArr.forEach(t => {
                    const ts = document.createElement('span');
                    ts.className = 'tag';
                    ts.textContent = '#' + t;
                    tagsContainer.appendChild(ts);
                });
                
                container.appendChild(itemEl);
            });

            document.getElementById('pageInfo').innerText = `ç¬¬ ${page} é¡µ`;
            document.getElementById('prevBtn').disabled = (page === 1);
            document.getElementById('nextBtn').disabled = !res.pagination.has_more;
        }

        function viewDetail(id) {
            window.location.href = `/detail?id=${id}`;
        }

        function doSearch(type) {
            if (type === 'all') document.getElementById('searchInput').value = '';
            render(type, document.getElementById('searchInput').value, 1);
        }

        function toggleShowArchived() {
            currentShowArchived = !currentShowArchived;
            const btn = document.getElementById('archiveToggleText');
            btn.textContent = currentShowArchived ? 'ğŸ“¦ éšè—å½’æ¡£' : 'ğŸ“¦ æ˜¾ç¤ºå½’æ¡£';
            render(currentType, currentQuery, 1);
        }

        function toggleFavoritedOnly() {
            currentFavoritedOnly = !currentFavoritedOnly;
            const btn = document.getElementById('favoriteToggleText');
            btn.textContent = currentFavoritedOnly ? 'â­ æ˜¾ç¤ºå…¨éƒ¨' : 'â­ ä»…çœ‹æ”¶è—';
            render(currentType, currentQuery, 1);
        }

        async function addData() {
            const templateRes = getTemplateContent();
            if (!templateRes) return;
            const { title, content } = templateRes;
            if (!content) return alert('å†…å®¹ä¸èƒ½ä¸ºç©º');
            
            const visibility = document.getElementById('visibilitySelect').value;
            const groupId = document.getElementById('groupSelect').value || null;
            const tagsRaw = document.getElementById('tagsInput').value;
            
            if (visibility === 'group' && !groupId) return alert('è¯·é€‰æ‹©å›¢é˜Ÿ');
            
            const btn = document.getElementById('addBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'æ­£åœ¨å­˜å…¥...';

            try {
                const res = await apiCall('/api/v1/items', 'POST', {
                    title,
                    content,
                    visibility,
                    group_id: visibility === 'group' ? parseInt(groupId, 10) : null,
                    tags: tagsRaw
                });
                
                if (res && res.status === 'success') {
                    showToast('å·²å­˜å…¥æƒ…æŠ¥ âœ¨');
                    document.getElementById('addTitle').value = '';
                    clearTemplateInputs();
                    document.getElementById('tagsInput').value = '';
                    render('all', '', 1);
                }
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function openManageTagsModal() {
            document.getElementById('manageTagsModal').style.display = 'flex';
            await loadTagsList();
        }

        function closeManageTagsModal() {
            document.getElementById('manageTagsModal').style.display = 'none';
        }

        async function loadTagsList() {
            const container = document.getElementById('tagsListContainer');
            container.innerHTML = '<div class="muted">æ­£åœ¨åŠ è½½...</div>';
            const res = await apiCall('/api/tags');
            if (!res || !res.tags) {
                container.innerHTML = '<div class="muted">åŠ è½½å¤±è´¥</div>';
                return;
            }
            if (res.tags.length === 0) {
                container.innerHTML = '<div class="muted">ä½ è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•æ ‡ç­¾</div>';
                return;
            }
            container.innerHTML = '';
            res.tags.forEach(t => {
                const div = document.createElement('div');
                div.className = 'tag-list-item';
                const labelStr = t.visibility === 'group' ? `<small class="muted">(å›¢é˜Ÿ)</small>` : '';
                div.innerHTML = `
                    <span><strong>#${t.name}</strong> ${labelStr}</span>
                    <span>
                        <button class="btn-ghost btn-small" onclick="renameTag(${t.id}, '${t.name}')">é‡å‘½å</button>
                        <button class="btn-ghost btn-small" style="color:red; border-color:red;" onclick="deleteTag(${t.id})">åˆ é™¤</button>
                    </span>
                `;
                container.appendChild(div);
            });
        }

        let renamingTagId = null;

        async function renameTag(id, name) {
            renamingTagId = id;
            document.getElementById('renameTagNameInput').value = name;
            document.getElementById('renameTagModal').style.display = 'flex';
        }

        function closeRenameTagModal() {
            document.getElementById('renameTagModal').style.display = 'none';
        }

        async function saveTagName() {
            const newName = document.getElementById('renameTagNameInput').value;
            if (newName) {
                const res = await apiCall(`/api/tags/${renamingTagId}`, 'PUT', { name: newName });
                if (res && res.status === 'success') {
                    closeRenameTagModal();
                    await loadTagsList();
                    render(currentType, currentQuery, currentPage);
                }
            }
        }

        async function deleteTag(id) {
            if (!confirm('ç¡®å®šè¦å½»åº•åˆ é™¤è¿™ä¸ªæ ‡ç­¾å—ï¼Ÿæ‰€æœ‰å…³è”çš„æƒ…æŠ¥å°†ä¸å†æ‹¥æœ‰æ­¤æ ‡ç­¾ã€‚')) return;
            const res = await apiCall(`/api/tags/${id}`, 'DELETE');
            if (res && res.status === 'success') {
                await loadTagsList();
                render(currentType, currentQuery, currentPage);
            }
        }

        function changePage(delta) { render(currentType, currentQuery, currentPage + delta); }

        async function revectorizeAll() {
            if (!confirm('è¿™å°†æ¶ˆè€—å¤§é‡ API é¢åº¦æ¥é‡æ–°æ„å»ºå…¨é‡å‘é‡ï¼Œç¡®å®šå—ï¼Ÿ')) return;
            const res = await apiCall('/api/v1/admin/revectorize-all', 'POST');
            if (res && res.status === 'success') {
                alert('åå°é‡æ„ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç¨ååˆ·æ–°ã€‚');
                render(currentType, currentQuery, currentPage);
            } else {
                alert('æ“ä½œå¤±è´¥ï¼Œå¯èƒ½æƒé™ä¸è¶³ã€‚');
            }
        }

        window.onload = async () => {
            if (!authToken) {
                window.location.href = '/login';
                return;
            }
            onVisibilityChange();
            await loadMe();
            await loadGroups();
            const params = new URLSearchParams(window.location.search);
            render(params.get('type') || 'all', params.get('q') || '', parseInt(params.get('page')) || 1);
        };
    </script>
</body>
</html>
